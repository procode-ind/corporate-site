---
// 404 page that redirects to language detection fallback
// This handles invalid routes and redirects users to the main site

import '../styles/global.css';

const SUPPORTED_LANGUAGES = ['es', 'en'] as const;
const DEFAULT_LANGUAGE = 'es' as const;
type SupportedLanguage = (typeof SUPPORTED_LANGUAGES)[number];

// Get browser's preferred language from Accept-Language header
function detectBrowserLanguage(acceptLanguageHeader: string | null): SupportedLanguage {
  if (!acceptLanguageHeader) {
    return DEFAULT_LANGUAGE;
  }

  // Parse Accept-Language header and find best match
  const languages = acceptLanguageHeader
    .split(',')
    .map((lang) => {
      const [code, quality = '1'] = lang.trim().split(';q=');
      return {
        code: code.split('-')[0].toLowerCase(),
        quality: parseFloat(quality),
      };
    })
    .sort((a, b) => b.quality - a.quality);

  // Find first supported language
  const preferredLang = languages.find((lang) =>
    SUPPORTED_LANGUAGES.includes(lang.code as SupportedLanguage),
  );

  return (preferredLang?.code as SupportedLanguage) || DEFAULT_LANGUAGE;
}

// Detect user's preferred language from request headers
const acceptLanguage = Astro.request.headers.get('accept-language');
const preferredLang = detectBrowserLanguage(acceptLanguage);
const base = import.meta.env.BASE_URL || '/';
const homeUrl = `${base}${preferredLang}/`;

// Localized 404 messages
const messages = {
  es: {
    title: 'P√°gina no encontrada',
    heading: '¬°Oops! P√°gina no encontrada',
    description: 'La p√°gina que buscas no existe o ha sido movida.',
    redirecting: 'Redirigiendo al inicio...',
    buttonText: 'Ir al inicio',
  },
  en: {
    title: 'Page not found',
    heading: 'Oops! Page not found',
    description: 'The page you are looking for does not exist or has been moved.',
    redirecting: 'Redirecting to home...',
    buttonText: 'Go to home',
  },
} as const;

const message = messages[preferredLang];

// Debug info (only in development)
const isDev = import.meta.env.DEV;
const debugInfo = isDev
  ? {
      requestedUrl: Astro.url.pathname,
      acceptLanguageHeader: acceptLanguage,
      detectedLang: preferredLang,
      redirectUrl: homeUrl,
    }
  : null;
---

<!doctype html>
<html lang={preferredLang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{message.title} - ProCode Ind</title>
    <meta name="description" content={message.description} />
    <meta http-equiv="refresh" content={`3; url=${homeUrl}`} />
    <meta name="robots" content="noindex, nofollow" />
    <link rel="canonical" href={`https://www.procodeind.com${homeUrl}`} />
    <link rel="icon" href="/favicon.svg" />

    <!-- Redirect after 3 seconds -->
    <script define:vars={{ homeUrl }}>
      setTimeout(() => {
        window.location.replace(homeUrl);
      }, 3000);
    </script>
  </head>
  <body
    class="flex min-h-screen items-center justify-center bg-gradient-to-br from-gray-900 via-gray-800 to-black font-sans text-white"
  >
    <div class="mx-4 max-w-lg rounded-xl bg-white/10 p-8 text-center shadow-2xl backdrop-blur-lg">
      <!-- 404 Icon -->
      <div class="mb-6 text-6xl">üîç</div>

      <h1 class="mb-4 text-3xl font-bold text-red-300">{message.heading}</h1>
      <p class="mb-6 leading-relaxed text-white/90">
        {message.description}
      </p>

      <!-- Redirect info -->
      <div class="mb-6 rounded-lg border border-blue-400/30 bg-blue-500/20 p-4">
        <div
          class="mr-2 inline-block h-4 w-4 animate-spin rounded-full border-2 border-blue-300/30 border-t-blue-300"
        >
        </div>
        <span class="text-blue-200">{message.redirecting}</span>
      </div>

      <a
        href={homeUrl}
        class="inline-block rounded-lg bg-blue-600 px-6 py-3 text-white no-underline transition-all duration-300 hover:bg-blue-500 focus:ring-2 focus:ring-blue-400 focus:outline-none"
      >
        {message.buttonText} ‚Üí
      </a>

      {/* Debug info in development */}
      {
        debugInfo && (
          <details class="mt-8 rounded-lg bg-black/20 p-4 text-left text-xs">
            <summary class="cursor-pointer font-mono text-yellow-300">
              üêõ Debug Info (Dev Mode)
            </summary>
            <div class="mt-2 space-y-1 font-mono text-white/80">
              <div>
                <strong>Requested URL:</strong> {debugInfo.requestedUrl}
              </div>
              <div>
                <strong>Accept-Language:</strong> {debugInfo.acceptLanguageHeader || 'null'}
              </div>
              <div>
                <strong>Detected Lang:</strong>{' '}
                <span class="text-green-300">{debugInfo.detectedLang}</span>
              </div>
              <div>
                <strong>Redirect URL:</strong> {debugInfo.redirectUrl}
              </div>
            </div>
          </details>
        )
      }
    </div>
  </body>
</html>
